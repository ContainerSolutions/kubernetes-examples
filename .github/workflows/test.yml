---
name: k8s-test

on:
  [push, pull_request]

jobs:
  apply-all-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: install kubeconform
        run: |
           curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar -zxf -
           sudo mv kubeconform /usr/local/bin
      - name: check all yaml
        run: |
          comm -3 <(find . | grep yaml$ | sort) <(cat .kubeconform-ignore | sort) | xargs -n1 kubeconform --strict | tee -a apply.txt
      - name: upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: apply-test-all-yaml
          path: apply.txt
      - name: check apply log for error
        run: |
          if grep '^ERR' apply.txt; then exit 1; fi
